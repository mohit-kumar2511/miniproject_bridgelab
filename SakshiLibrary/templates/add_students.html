{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-user-plus"></i> New Admission</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="admissionForm">
                    <!-- Confirmation Alert - Shows outside demoFields so always visible -->
                    <div id="existingDemoAlert" style="display: none;" class="alert alert-warning mb-3 border border-warning">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                            <div class="flex-grow-1">
                                <h5 class="alert-heading mb-2">⚠️ यह बच्चा पहले से Demo ले चुका है!</h5>
                                <div id="pastDemoDetails" class="mt-2 mb-3"></div>
                                <div class="form-check">
                                    <input type="checkbox" name="confirm_duplicate_demo" value="yes" class="form-check-input" id="confirmDuplicateDemo" required>
                                    <label class="form-check-label fw-bold" for="confirmDuplicateDemo">
                                        ✅ हाँ, मैं इस बच्चे को फिर से Demo देना चाहता हूँ
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_demo" id="isDemoCheck" onchange="toggleDemoFields()">
                        <label class="form-check-label" for="isDemoCheck">
                            <strong>Is this a Demo Student?</strong> (Only Name, Village, Mobile & Demo Days required)
                        </label>
                    </div>

                    <div id="demoFields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" id="demoName">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
                                <input type="text" name="mobile" class="form-control" id="demoMobile" onblur="checkMobile()" oninput="checkMobileRealTime()">
                                <small class="text-muted">Enter mobile to check if already exists as demo</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Address / Village <span class="text-danger">*</span></label>
                                <input type="text" name="address" class="form-control" id="demoAddress">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Demo Days <span class="text-danger">*</span></label>
                                <input type="number" name="demo_days" class="form-control" id="demoDays" value="7" min="1" max="30">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Demo Start Date <span class="text-danger">*</span></label>
                                <input type="date" name="admission_date" class="form-control" id="demoAdmDate" value="{{ date.today().strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Photo (Optional)</label>
                                <input type="file" name="photo" class="form-control" accept="image/*">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning w-100 btn-lg" id="demoSubmitBtn">
                            <i class="fas fa-user-clock"></i> Add Demo Student
                        </button>
                    </div>

                    <div id="fullFields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Father's Name <span class="text-danger">*</span></label>
                                <input type="text" name="father_name" class="form-control" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
                                <input type="text" name="mobile" class="form-control" required onblur="checkMobile()">
                                <small class="text-muted">Enter mobile to check if already exists as demo</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Gender <span class="text-danger">*</span></label>
                                <select name="gender" class="form-control" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Admission Date <span class="text-danger">*</span></label>
                                <input type="date" name="admission_date" class="form-control" required value="{{ date.today().strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Payment Date</label>
                                <input type="date" name="payment_date" class="form-control" value="{{ date.today().strftime('%Y-%m-%d') }}">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Address / Village</label>
                                <input type="text" name="address" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Locker Number (optional)</label>
                                <input type="text" name="locker_number" class="form-control" placeholder="e.g. L-12">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Seat Reservation?</label>
                                <select name="seat_reserved" class="form-control">
                                    <option value="yes">Yes</option>
                                    <option value="no" selected>No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Photo</label>
                                <input type="file" name="photo" class="form-control" accept="image/*">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Library Fees</label>
                                <input type="number" name="library_fee" class="form-control" placeholder="Total fee" min="0" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Discount</label>
                                <input type="number" name="discount" class="form-control" value="0" min="0" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Amount Paid Now</label>
                                <input type="number" name="amount_paid" class="form-control" placeholder="Received now" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Payment Mode</label>
                                <select name="payment_mode" class="form-control">
                                    <option value="Cash">Cash</option>
                                    <option value="Online">Online</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Notes / Due breakdown</label>
                                <textarea name="notes" class="form-control" rows="2" placeholder="Due details, locker/seat remarks, etc."></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg">Complete Admission</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function toggleDemoFields() {
    const isDemo = document.getElementById('isDemoCheck').checked;
    const demoFields = document.getElementById('demoFields');
    const fullFields = document.getElementById('fullFields');
    
    if (isDemo) {
        demoFields.style.display = 'block';
        fullFields.style.display = 'none';
        // Make demo fields required
        document.getElementById('demoName').required = true;
        document.getElementById('demoMobile').required = true;
        document.getElementById('demoAddress').required = true;
        document.getElementById('demoDays').required = true;
        document.getElementById('demoAdmDate').required = true;
        // Make full fields not required
        const fullInputs = fullFields.querySelectorAll('input[required], select[required]');
        fullInputs.forEach(input => input.required = false);
    } else {
        demoFields.style.display = 'none';
        fullFields.style.display = 'block';
        // Make demo fields not required
        const demoInputs = demoFields.querySelectorAll('input[required]');
        demoInputs.forEach(input => input.required = false);
        // Make full fields required
        const fullInputs = fullFields.querySelectorAll('input[required], select[required]');
        fullInputs.forEach(input => input.required = true);
    }
}

function checkMobile() {
    const mobile = document.getElementById('demoMobile')?.value || document.querySelector('#fullFields input[name="mobile"]')?.value;
    if (mobile && mobile.length >= 10) {
        checkMobileRealTime();
    }
}

let hasExistingDemo = false;

function checkMobileRealTime() {
    const mobileInput = document.getElementById('demoMobile');
    if (!mobileInput) return;
    
    let mobile = mobileInput.value.trim().replace(/\s+/g, '').replace(/[^\d]/g, '');
    if (!mobile || mobile.length < 10) {
        document.getElementById('existingDemoAlert').style.display = 'none';
        hasExistingDemo = false;
        const confirmCheck = document.querySelector('input[name="confirm_duplicate_demo"]');
        if (confirmCheck) {
            confirmCheck.required = false;
            confirmCheck.checked = false;
        }
        return;
    }
    
    console.log('Checking mobile:', mobile);
    
    // AJAX call to check mobile
    fetch(`/check_demo_mobile?mobile=${encodeURIComponent(mobile)}`)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.exists && data.demos && data.demos.length > 0) {
                hasExistingDemo = true;
                const alertDiv = document.getElementById('existingDemoAlert');
                const detailsDiv = document.getElementById('pastDemoDetails');
                
                if (!alertDiv || !detailsDiv) {
                    console.error('Alert elements not found');
                    return;
                }
                
                let html = '<strong>पिछली Demo Entry:</strong><ul class="mb-0 mt-2" style="list-style-type: disc; padding-left: 20px;">';
                data.demos.forEach(demo => {
                    const demoDate = demo.admission_date ? new Date(demo.admission_date).toLocaleDateString('en-GB') : 'N/A';
                    const expiryDate = demo.expiry_date ? new Date(demo.expiry_date).toLocaleDateString('en-GB') : 'N/A';
                    html += `<li style="margin-bottom: 5px;"><strong>Demo ID:</strong> ${demo.uid} | <strong>Name:</strong> ${demo.name} | <strong>Demo Date:</strong> ${demoDate} | <strong>Demo Days:</strong> ${demo.demo_days} | <strong>Expired:</strong> ${expiryDate}</li>`;
                });
                html += '</ul>';
                
                detailsDiv.innerHTML = html;
                alertDiv.style.display = 'block';
                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Make confirmation checkbox required
                const confirmCheck = document.querySelector('input[name="confirm_duplicate_demo"]');
                if (confirmCheck) {
                    confirmCheck.required = true;
                }
            } else {
                hasExistingDemo = false;
                document.getElementById('existingDemoAlert').style.display = 'none';
                const confirmCheck = document.querySelector('input[name="confirm_duplicate_demo"]');
                if (confirmCheck) {
                    confirmCheck.required = false;
                    confirmCheck.checked = false;
                }
            }
        })
        .catch(error => {
            console.error('Error checking mobile:', error);
            hasExistingDemo = false;
        });
}

// Prevent form submission if duplicate demo exists and not confirmed
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('admissionForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const isDemo = document.getElementById('isDemoCheck')?.checked;
            if (isDemo) {
                const mobile = document.getElementById('demoMobile')?.value;
                // Check again on submit to make sure
                if (mobile && mobile.length >= 10) {
                    // Quick check - if alert is visible, confirmation is required
                    const alertDiv = document.getElementById('existingDemoAlert');
                    if (alertDiv && alertDiv.style.display !== 'none') {
                        const confirmCheck = document.querySelector('input[name="confirm_duplicate_demo"]');
                        if (!confirmCheck || !confirmCheck.checked) {
                            e.preventDefault();
                            alert('⚠️ कृपया confirm करें कि आप इस बच्चे को फिर से Demo देना चाहते हैं!');
                            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            if (confirmCheck) {
                                confirmCheck.focus();
                            }
                            return false;
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
